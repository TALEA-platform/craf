<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Rifugi climatici & fragilit√† urbana ‚Äì TALEA / SUOA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- TopoJSON -->
  <script src="https://unpkg.com/topojson-client@3"></script>

  <style>
    :root {
      --talea-green: #0b7a4b;
      --talea-blue: #0b7a4b;
      --talea-yellow: #ffcc33;
      --bg-light: #f5f7fb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --card-radius: 14px;
      --shadow-soft: 0 2px 6px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg-light);
      color: var(--text-main);
    }

    /* Topbar */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 1.5rem;
      background: #ffffff;
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .topbar-title {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-main);
    }

    .topbar-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .topbar-right a {
      color: var(--text-muted);
      text-decoration: none;
    }

    .topbar-right a:hover {
      text-decoration: underline;
    }

    .lang-btn {
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #ffffff;
      border-radius: 999px;
      padding: 0.15rem 0.55rem;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      color: var(--text-muted);
    }

    .lang-btn.active {
      background: var(--talea-green);
      color: #ffffff;
      border-color: var(--talea-green);
    }

    .info-btn {
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #ffffff;
      border-radius: 999px;
      padding: 0.15rem 0.55rem;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      color: var(--text-muted);
    }

    header.hero {
      padding: 1.5rem 1.5rem 0.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    header.hero h1 {
      margin: 0;
      font-size: 1.55rem;
      color: var(--talea-green);
    }

    header.hero p {
      margin: 0.4rem 0 0.2rem;
      color: var(--text-muted);
      font-size: 0.95rem;
      max-width: 820px;
    }

    .hero-tagline {
      font-size: 0.85rem;
      color: var(--talea-green);
      margin-top: 0.4rem;
    }

    main.container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem 2rem;
    }

    /* Hero cards */
    .hero-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-top: 1rem;
      margin-bottom: 1rem;
    }

    .hero-card {
      background: #ffffff;
      border-radius: var(--card-radius);
      padding: 0.9rem 1rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.25);
      position: relative;
      overflow: hidden;
    }

    .hero-card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 2px solid transparent;
      border-image: linear-gradient(
          135deg,
          rgba(11, 122, 75, 0.2),
          rgba(0, 134, 201, 0),
          rgba(255, 204, 51, 0.4)
        )
        1;
      opacity: 0.9;
      pointer-events: none;
    }

    .hero-card span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .hero-card h2 {
      margin: 0.25rem 0;
      font-size: 1.7rem;
      color: var(--talea-green);
    }

    .hero-card small {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Tabs CSI / CFI */
    .tabs {
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      display: inline-flex;
      border-radius: 999px;
      padding: 0.15rem;
      background: #e5edf9;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 0.35rem 0.95rem;
      font-size: 0.85rem;
      border-radius: 999px;
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .tab-btn span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.25);
    }

    .tab-btn.active {
      background: #ffffff;
      color: var(--talea-green);
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.12);
    }

    .tab-btn.active span.dot {
      background: var(--talea-green);
    }

    .section-title {
      margin: 1.5rem 0 0.2rem;
      font-size: 1.25rem;
      color: var(--talea-green);
    }

    .section-subtitle {
      margin: 0 0 0.8rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .two-columns {
      display: grid;
      grid-template-columns: 2fr 1.5fr;
      gap: 1rem;
      align-items: stretch;
    }

    .card {
      background: #ffffff;
      border-radius: var(--card-radius);
      padding: 1rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.35);
      height: 100%;
    }

    #map-csi,
    #map-cfi,
    #map-csi-parks {
      width: 100%;
      height: 420px;
      border-radius: 10px;
      overflow: hidden;
    }

    canvas {
      max-width: 100%;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
      margin-bottom: 0.75rem;
    }

    .chip {
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.8rem;
      cursor: pointer;
      background: #f9fafb;
      color: var(--text-muted);
    }

    .chip.active {
      background: var(--talea-green);
      color: #ffffff;
      border-color: var(--talea-green);
    }

    .card h3 {
      margin: 0;
      font-size: 0.95rem;
      color: var(--talea-green);
    }

    .card hr {
      border: none;
      border-top: 1px solid rgba(148, 163, 184, 0.35);
      margin: 0.8rem 0;
    }

    .hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.4rem;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .map-toolbar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 0.3rem;
      gap: 0.35rem;
    }

    .map-toggle-btn {
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #ffffff;
      color: var(--text-muted);
      border-radius: 999px;
      font-size: 0.75rem;
      padding: 0.15rem 0.7rem;
      cursor: pointer;
    }

    .compare-bar {
      display: flex;
      justify-content: flex-end;
      margin: 0.5rem 0 0.5rem;
    }

    /* Slider opacit√† */
    .map-opacity-label {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .map-opacity-label input[type="range"] {
      width: 120px;
    }

    /* Fullscreen overlay CSI/CFI */
    .fullscreen-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
      display: none;
      align-items: stretch;
      justify-content: center;
      z-index: 999;
    }

    .fullscreen-overlay.active {
      display: flex;
    }

    .fullscreen-panel {
      background: #0b1120;
      flex: 1;
      max-width: 1200px;
      margin: 1rem;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .fullscreen-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 0.9rem;
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    .fullscreen-title {
      font-weight: 500;
    }

    .fullscreen-close {
      border: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 1.1rem;
      cursor: pointer;
    }

    .compare-slider-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.9rem;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
    }

    .compare-slider-wrapper input[type="range"] {
      flex: 1;
    }

    #map-compare {
      flex: 1;
      min-height: 380px;
    }

    .fullscreen-footer {
      padding: 0.4rem 0.9rem;
      background: #020617;
      color: #9ca3af;
      font-size: 0.75rem;
    }

    /* DataTables */
    table.dataTable {
      font-size: 0.8rem;
      width: 100%;
    }

    table.dataTable thead th {
      font-weight: 600;
      color: var(--talea-green);
    }

    table.dataTable tbody tr:nth-child(even) {
      background-color: #f9fafb;
    }

    table.dataTable tbody tr:hover {
      cursor: pointer;
      background-color: #e5f4ec;
    }

    .table-wrapper {
      margin-top: 0.6rem;
      overflow: auto;
    }

    /* Sezione parchi: card con mappa + tabella 50/50 */
    .parks-card {
      height: 600px;
      display: flex;
      flex-direction: column;
    }

    .parks-split {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-height: 0;
    }

    .parks-map-wrapper,
    .parks-table-wrapper {
      flex: 1;
      min-height: 0;
    }

    #map-csi-parks {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      overflow: hidden;
    }

    .parks-table-wrapper {
      overflow: auto;
    }

    /* Modal info */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-dialog {
      background: #ffffff;
      border-radius: 14px;
      max-width: 720px;
      width: 100%;
      margin: 1rem;
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.3);
      display: flex;
      flex-direction: column;
      max-height: 85vh;
      overflow: hidden;
    }

    .modal-header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1rem;
      color: var(--talea-green);
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 1.1rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-body {
      padding: 0.9rem 1rem 1rem;
      overflow: auto;
      font-size: 0.9rem;
      color: var(--text-main);
    }

    .modal-body p {
      margin: 0 0 0.6rem;
    }

    .modal-body ul {
      padding-left: 1.1rem;
      margin: 0.25rem 0 0.6rem;
    }

    .modal-body li {
      margin-bottom: 0.25rem;
    }

    /* Indicatori section */
    .indicators-list {
      margin: 0.5rem 0 0;
      padding-left: 0;
      list-style: none;
      font-size: 0.85rem;
      color: var(--text-main);
    }

    .indicators-list li {
      margin-bottom: 0.45rem;
    }

    .indicators-list strong {
      color: var(--talea-green);
    }

    @media (max-width: 900px) {
      header.hero,
      main.container {
        padding: 0.75rem 1rem 1.5rem;
      }

      .hero-grid {
        grid-template-columns: 1fr;
      }

      .two-columns {
        grid-template-columns: 1fr;
      }

      #map-csi,
      #map-cfi {
        height: 320px;
      }

      .parks-card {
        height: 520px;
      }
    }
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-left">
      <div>
        <img src="assets/images/talea-logo.svg" width="50" alt="TALEA logo" />
      </div>
      <div>
        <div class="topbar-title" data-i18n="topbarTitle">
          Climate shelters & fragilit√†
        </div>
        <div class="topbar-subtitle" data-i18n="topbarSubtitle">
          Bologna - Italy
        </div>
      </div>
    </div>
    <div class="topbar-right">
      <button class="info-btn" id="open-info-modal">
        ‚ÑπÔ∏è <span data-i18n="infoButtonLabel">Info pagina</span>
      </button>
      <span data-i18n="topbarRight">
        <a href="https://talea-platform.github.io/">Talea Project</a>
      </span>
      <button class="lang-btn active" data-lang="it">üáÆüáπ IT</button>
      <button class="lang-btn" data-lang="en">üá¨üáß EN</button>
    </div>
  </div>

  <!-- HERO -->
  <header class="hero">
    <h1 data-i18n="heroTitle">Rifugi climatici & fragilit√† urbana</h1>
    <p data-i18n="heroParagraph">
      Bologna come laboratorio per capire cosa rende efficace un rifugio
      climatico, come si intreccia con la fragilit√† urbana e come TALEA pu√≤
      guidare le scelte di pianificazione.
    </p>
    <div class="hero-tagline" data-i18n="heroTagline">
      Dal verde generico ai climate shelters: dati, mappe e storie per il SUOA.
    </div>
  </header>

  <main class="container">
    <!-- NUMERI CHIAVE -->
    <section>
      <div class="hero-grid">
        <div class="hero-card">
          <span data-i18n="heroCard1Label">Spazi verdi analizzati</span>
          <h2 id="stat-total-parks">‚Äì</h2>
          <small data-i18n="heroCard1Small">
            aree verdi pubbliche considerate nel modello CSI
          </small>
        </div>
        <div class="hero-card">
          <span data-i18n="heroCard2Label">Candidati rifugi climatici</span>
          <h2 id="stat-csi-eligible">‚Äì</h2>
          <small data-i18n="heroCard2Small">
            superficie &gt; 0.5 ha e NDVI &gt; 0.4 (proxy: CSI &gt; 0)
          </small>
        </div>
        <div class="hero-card">
          <span data-i18n="heroCard3Label">Range osservato CFI</span>
          <h2>0.18 ‚Äì 0.81</h2>
          <small data-i18n="heroCard3Small">
            fragilit√† climatica normalizzata per area statistica
          </small>
        </div>
      </div>
    </section>

    <!-- SEZIONE PARCHI CSI (mappa + tabella) -->
    <section id="parks-csi-section">
      <h2 class="section-title" data-i18n="parksSectionTitle">
        Parchi e Climate Shelter Index (CSI)
      </h2>
      <p class="section-subtitle" data-i18n="parksSectionSubtitle">
        I singoli parchi di Bologna, con intensit√† di verde proporzionale al loro CSI. La tabella consente di filtrare e
        selezionare un parco per localizzarlo in mappa.
      </p>

      <div class="card parks-card">
        <div class="map-toolbar">
          <button id="toggle-csi-parks-layer" class="map-toggle-btn" data-i18n="parksToggleLayer">
            Nascondi layer
          </button>
          <button id="fullscreen-csi-parks" class="map-toggle-btn" data-i18n="parksFullscreenBtn">
            Fullscreen
          </button>
        </div>

        <div class="parks-split">
          <div class="parks-map-wrapper">
            <div id="map-csi-parks"></div>
          </div>

          <div class="parks-table-wrapper">
            <h3 data-i18n="parksTableTitle">
              Elenco parchi e indicatori CSI
            </h3>
            <table id="parks-table" class="display" style="width:100%">
              <thead>
                <tr>
                  <th style="display:none;" data-i18n="tableParksIdx">Idx</th>
                  <th data-i18n="tableParksDistrict">Quartiere</th>
                  <th data-i18n="tableParksName">Nome parco</th>
                  <th data-i18n="tableParksLocation">Ubicazione</th>
                  <th data-i18n="tableParksLanduse">Classe uso</th>
                  <th data-i18n="tableParksNDVI">NDVI</th>
                  <th data-i18n="tableParksAccess">Accesso</th>
                  <th data-i18n="tableParksCSI">CSI</th>
                  <th data-i18n="tableParksAreaHa">Area (ha)</th>
                  <th data-i18n="tableParksBus5">Fermate bus &lt; 5'</th>
                  <th data-i18n="tableParksPicnic">Picnic</th>
                  <th data-i18n="tableParksBenches">Panchine</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="hint" data-i18n="parksTableHint">
              La tabella mostra le prime 10 righe; puoi cercare per nome, quartiere o ordinare per NDVI/CSI per
              identificare i parchi pi√π efficaci come rifugi climatici.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TABS -->
    <section>
      <div class="tabs">
        <button class="tab-btn active" data-tab="tab-csi">
          <span class="dot"></span>
          <span data-i18n="tabCSI">Rifugi climatici (CSI)</span>
        </button>
        <button class="tab-btn" data-tab="tab-cfi">
          <span class="dot"></span>
          <span data-i18n="tabCFI">Fragilit√† & accesso ai rifugi</span>
        </button>
      </div>
    </section>

    <!-- BOTTONE CONFRONTO FULLSCREEN -->
    <section class="compare-bar">
      <button id="open-compare" class="map-toggle-btn" data-i18n="compareButton">
        Confronta CSI / CFI (mappa fullscreen)
      </button>
    </section>

    <!-- TAB CSI -->
    <section id="tab-csi" class="tab-panel active">
      <h2 class="section-title" data-i18n="csiSectionTitle">
        Dove sono e come funzionano i rifugi climatici
      </h2>
      <p class="section-subtitle" data-i18n="csiSectionSubtitle">
        Non tutti i parchi sono rifugi climatici: qui vediamo qualit√† (CSI), dotazioni e accessibilit√† dei green spaces
        bolognesi.
      </p>

      <div class="two-columns">
        <div class="card">
          <div class="filters" id="csi-filters">
            <div class="chip active" data-class="all" data-i18n="chipAll">Tutti</div>
          </div>

          <div class="map-toolbar">
            <label class="map-opacity-label">
              <span data-i18n="opacityLabel">Opacit√†:</span>
              <input type="range" id="opacity-csi" min="0.1" max="1" step="0.05" value="0.75">
            </label>
          </div>

          <div id="map-csi"></div>
          <div class="hint" data-i18n="csiHint">
            Usa lo slider di opacit√† per leggere meglio il contesto urbano sotto il layer CSI.
          </div>
        </div>
        <div class="card">
          <h3 data-i18n="csiHistTitle">Distribuzione del Climate Shelter Index (CSI)</h3>
          <canvas id="chart-csi-hist"></canvas>
          <div class="hint" data-i18n="csiHistHint">
            L‚Äôistogramma mostra quante aree verdi rientrano in ciascun intervallo di CSI: √® la base per capire quanto la
            citt√† √® dotata di rifugi climatici efficaci.
          </div>
          <hr />
          <h3 data-i18n="amenitiesTitle">Composizione climatica delle aree</h3>
          <canvas id="chart-amenities"></canvas>
          <div class="hint" data-i18n="amenitiesHint">
            Verde, blu, hot e cold area: valori medi percentuali per area statistica.
          </div>
        </div>
      </div>

      <!-- Tabella aree CSI -->
      <div class="card" style="margin-top:1rem;">
        <h3 data-i18n="csiAreasTableTitle">Aree statistiche e indicatori CSI</h3>
        <p class="section-subtitle" data-i18n="csiAreasTableSubtitle">
          Ogni riga rappresenta un‚Äôarea statistica: cliccando sul nome la mappa si sposta per mostrarla, con il suo
          valore di CSI e la composizione climatica.
        </p>
        <div class="table-wrapper">
          <table id="csi-areas-table" class="display" style="width:100%;">
            <thead>
              <tr>
                <th style="display:none;" data-i18n="tableAreasIdx">Idx</th>
                <th data-i18n="tableAreasName">Area statistica</th>
                <th data-i18n="tableAreasCSI">CSI medio</th>
                <th data-i18n="tableAreasCS">N. climate shelters (CS)</th>
                <th data-i18n="tableAreasGreen">Green %</th>
                <th data-i18n="tableAreasBlue">Blue %</th>
                <th data-i18n="tableAreasHot">Hot area %</th>
                <th data-i18n="tableAreasCold">Cold area %</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="hint" data-i18n="csiAreasTableHint">
          Usa la ricerca per confrontare rapidamente quartieri diversi, e ordina per CSI o per green% per individuare
          dove i rifugi climatici sono pi√π efficaci.
        </div>
      </div>
    </section>

    <!-- TAB CFI -->
    <section id="tab-cfi" class="tab-panel">
      <h2 class="section-title" data-i18n="cfiSectionTitle">
        Fragilit√† climatica e sociale per quartiere
      </h2>
      <p class="section-subtitle" data-i18n="cfiSectionSubtitle">
        Le aree pi√π fragili combinano esposizione al calore, scarsa presenza di rifugi climatici e vulnerabilit√†
        socio-economica. Qui vediamo come questi fattori si intrecciano nello spazio urbano.
      </p>

      <div class="two-columns">
        <div class="card">
          <div class="map-toolbar">
            <label class="map-opacity-label">
              <span data-i18n="opacityLabel">Opacit√†:</span>
              <input type="range" id="opacity-cfi" min="0.1" max="1" step="0.05" value="0.4">
            </label>
          </div>
          <div id="map-cfi"></div>
          <div class="hint" data-i18n="cfiHint">
            Passa il mouse sulle aree statistiche per leggere CFI (fragilit√† climatica), F complessivo e HF. Usa lo
            slider per modulare la lettura tra layer e base map.
          </div>
        </div>
        <div class="card">
          <h3 data-i18n="cfiVsCsiTitle">CFI vs qualit√† dei rifugi (CSI medio)</h3>
          <canvas id="chart-cfi-vs-csi"></canvas>
          <div class="hint" data-i18n="cfiVsCsiHint">
            Ogni punto √® un‚Äôarea statistica: in alto a sinistra trovi le zone con alta fragilit√† climatica e rifugi di
            bassa qualit√† ‚Äî i candidati naturali per interventi TALEA.
          </div>
          <hr />
          <h3 data-i18n="fragilityClassTitle">Classi di fragilit√† complessiva (F)</h3>
          <canvas id="chart-fragility-classes"></canvas>
          <div class="hint" data-i18n="fragilityClassHint">
            La distribuzione per classi mostra quanto la fragilit√† climatica contribuisce a spostare i quartieri verso
            livelli di rischio pi√π elevati.
          </div>
        </div>
      </div>

      <!-- Tabella aree CFI -->
      <div class="card" style="margin-top:1rem;">
        <h3 data-i18n="cfiAreasTableTitle">Aree statistiche e indicatori di fragilit√†</h3>
        <p class="section-subtitle" data-i18n="cfiAreasTableSubtitle">
          La tabella elenca le aree statistiche con i relativi indici di fragilit√†: clicca sul nome per centrare la
          mappa sulla zona selezionata.
        </p>
        <div class="table-wrapper">
          <table id="cfi-areas-table" class="display" style="width:100%;">
            <thead>
              <tr>
                <th style="display:none;" data-i18n="tableAreasIdx">Idx</th>
                <th data-i18n="tableAreasName">Area statistica</th>
                <th data-i18n="tableAreasCFI">CFI climatico (N_f_clim)</th>
                <th data-i18n="tableAreasF">Fragilit√† complessiva (N_frag2)</th>
                <th data-i18n="tableAreasFragClass">Classe fragilit√†</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="hint" data-i18n="cfiAreasTableHint">
          Ordina per fragilit√† complessiva per identificare rapidamente i quartieri prioritari e confronta il dato con
          il CFI per capire quanto conta il caldo rispetto ad altri fattori.
        </div>
      </div>
    </section>

    <!-- SEZIONE INDICATORI (SPIEGAZIONI) -->
    <section id="indicators-section">
      <h2 class="section-title" data-i18n="indicatorsSectionTitle">
        Come leggere gli indicatori
      </h2>
      <p class="section-subtitle" data-i18n="indicatorsSectionSubtitle">
        Alcuni indicatori sono tecnici: qui trovi una breve guida di lettura per collegare numeri, mappe e scelte
        operative.
      </p>
      <div class="card">
        <ul class="indicators-list">
          <li data-i18n="indicatorsCSI">
            <strong>CSI (Climate Shelter Index)</strong> ‚Äì misura quanto un‚Äôarea verde funziona come rifugio climatico,
            combinando ombra, vegetazione, acqua e accessibilit√†. Valori prossimi a 1 indicano rifugi molto efficaci.
          </li>
          <li data-i18n="indicatorsCFI">
            <strong>CFI (N_f_clim)</strong> ‚Äì quota della fragilit√† complessiva dovuta al caldo: pi√π √® alto, pi√π una
            zona soffre gli effetti del calore estremo rispetto ad altri fattori.
          </li>
          <li data-i18n="indicatorsF">
            <strong>F (N_frag2)</strong> ‚Äì indice sintetico di fragilit√† climatica e sociale per area statistica: mette
            insieme esposizione, vulnerabilit√† e capacit√† di risposta.
          </li>
          <li data-i18n="indicatorsGreenBlue">
            <strong>Green % / Blue %</strong> ‚Äì percentuale di superficie coperta da vegetazione o acqua in ciascuna
            area, elementi chiave per mitigare le isole di calore urbane.
          </li>
          <li data-i18n="indicatorsHotCold">
            <strong>Hot / Cold area %</strong> ‚Äì quota di territorio che sperimenta temperature particolarmente alte o
            pi√π mitigate rispetto al contesto urbano circostante.
          </li>
          <li data-i18n="indicatorsAccess">
            <strong>Accesso e servizi</strong> ‚Äì indicatori come fermate bus entro 5 minuti, panchine, tavoli picnic e
            superficie (ha) aiutano a capire quanto un rifugio sia realmente utilizzabile dalla popolazione.
          </li>
        </ul>
      </div>
    </section>
  </main>

  <!-- FULLSCREEN OVERLAY: CONFRONTO CSI / CFI -->
  <div id="fullscreen-compare" class="fullscreen-overlay">
    <div class="fullscreen-panel">
      <div class="fullscreen-header">
        <div class="fullscreen-title" data-i18n="compareTitle">
          Confronto CSI / CFI ¬∑ Bologna
        </div>
        <button class="fullscreen-close" id="close-compare">
          ‚úï
        </button>
      </div>
      <div class="compare-slider-wrapper">
        <span data-i18n="compareOnlyCSI">Solo CSI</span>
        <input type="range" id="compare-slider" min="0" max="1" step="0.05" value="0.5" />
        <span data-i18n="compareOnlyCFI">Solo CFI</span>
      </div>
      <div id="map-compare"></div>
      <div class="fullscreen-footer" data-i18n="compareFooter">
        Trascina lo slider per passare dai rifugi climatici (CSI) alla fragilit√† complessiva (CFI). Il layer CSI √® in
        verde, il CFI in viola.
      </div>
    </div>
  </div>

  <!-- MODAL INFO -->
  <div id="info-modal" class="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-header">
        <h2 data-i18n="infoModalTitle">Cosa vedi in questa pagina</h2>
        <button class="modal-close" id="close-info-modal">‚úï</button>
      </div>
      <div class="modal-body">
        <p data-i18n="infoModalIntro">
          Questa pagina usa i dati del progetto TALEA per raccontare, con mappe e grafici interattivi, come i rifugi
          climatici e la fragilit√† urbana si distribuiscono nello spazio di Bologna.
        </p>
        <p data-i18n="infoModalSection1">
          Nella prima sezione trovi i parchi, con il loro Climate Shelter Index (CSI) e alcuni indicatori chiave:
          vegetazione (NDVI), accessibilit√†, servizi e superficie. La mappa e la tabella lavorano insieme: selezionando
          un parco, la mappa si centra sull‚Äôarea corrispondente.
        </p>
        <p data-i18n="infoModalSection2">
          La scheda ‚ÄúRifugi climatici (CSI)‚Äù mostra come la qualit√† dei rifugi cambia tra le diverse aree statistiche,
          sia in forma cartografica sia come distribuzione numerica. L‚Äôistogramma aiuta a capire se i rifugi di qualit√†
          sono concentrati o diffusi.
        </p>
        <p data-i18n="infoModalSection3">
          La scheda ‚ÄúFragilit√† & accesso ai rifugi‚Äù integra indicatori climatici e sociali: la mappa evidenzia le aree
          pi√π fragili, mentre i grafici mettono in relazione CFI e qualit√† dei rifugi. La tabella permette di
          identificare rapidamente i quartieri prioritari.
        </p>
        <p data-i18n="infoModalSection4">
          Tutte le sezioni sono pensate per supportare il Systemic Urban Observation Atlas (SUOA) di TALEA: l‚Äôobiettivo
          non √® solo mostrare dati, ma favorire decisioni informate su dove investire per migliorare l‚Äôadattamento al
          caldo urbano.
        </p>
        <ul>
          <li data-i18n="infoModalBullet1">
            Usa le mappe per identificare pattern spaziali.
          </li>
          <li data-i18n="infoModalBullet2">
            Usa le tabelle per filtrare, ordinare e cercare casi specifici.
          </li>
          <li data-i18n="infoModalBullet3">
            Usa i grafici per confrontare distribuzioni e relazioni tra indicatori.
          </li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    /* =====================
       1. i18n
    ====================== */
    let I18N = { it: null, en: null };
    let currentLang = "it";

    async function loadI18n() {
      const [itResp, enResp] = await Promise.all([
        fetch("assets/i18n/it.json"),
        fetch("assets/i18n/en.json"),
      ]);
      I18N.it = await itResp.json();
      I18N.en = await enResp.json();
    }

    function applyI18n() {
      const t = I18N[currentLang];
      if (!t) return;
      document.querySelectorAll("[data-i18n]").forEach((el) => {
        const key = el.getAttribute("data-i18n");
        if (t[key] !== undefined) {
          el.textContent = t[key];
        }
      });
    }

    function updateLanguageButtons() {
      document.querySelectorAll(".lang-btn").forEach((btn) => {
        btn.classList.remove("active");
      });
      const active = document.querySelector(
        `.lang-btn[data-lang='${currentLang}']`
      );
      if (active) active.classList.add("active");
    }

    function initLangSwitch() {
      document.querySelectorAll(".lang-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const lang = btn.dataset.lang;
          if (!lang || lang === currentLang) return;
          currentLang = lang;
          applyI18n();
          updateLanguageButtons();
          updateChartsLanguage();
          updateTablesLanguage();
        });
      });
    }

    /* =====================
       2. Config dati
    ====================== */
    const CSI_GEOJSON_URL = "assets/data/green_spaces_csi.geojson";
    const CFI_GEOJSON_URL = "assets/data/fragility_areas.geojson";
    const CSI_PARKS_GEOJSON_URL = "assets/data/csi.geojson"; // TopoJSON o GeoJSON
    const BASEMAP_STYLE = "https://tiles.openfreemap.org/styles/liberty";

    /* =====================
       3. Variabili globali
    ====================== */
    let csiData = null;
    let cfiData = null;
    let csiParksData = null;
    let mapCSI, mapCFI, mapCompare, mapCSIParks;
    let csiHistChart, amenitiesChart, cfiVsCsiChart, fragilityClassChart;
    let csiStats = null;
    let fragStats = null;
    let parksTable = null;
    let csiAreasTable = null;
    let cfiAreasTable = null;

    const dtLangIt = {
      search: "Cerca:",
      info: "Mostra _START_‚Äì_END_ di _TOTAL_ elementi",
      infoEmpty: "Nessun elemento disponibile",
      zeroRecords: "Nessun elemento trovato",
      paginate: {
        first: "Prima",
        last: "Ultima",
        next: "Avanti",
        previous: "Indietro",
      },
    };

    const dtLangEn = {
      search: "Search:",
      info: "Showing _START_‚Äì_END_ of _TOTAL_ entries",
      infoEmpty: "No entries available",
      zeroRecords: "No matching entries found",
      paginate: {
        first: "First",
        last: "Last",
        next: "Next",
        previous: "Previous",
      },
    };

    /* =====================
       4. Helper
    ====================== */
    function toNum(v) {
      if (v === null || v === undefined) return NaN;
      if (typeof v === "string") v = v.replace(",", ".");
      const n = Number(v);
      return isNaN(n) ? NaN : n;
    }

    function classifyCSI(csi) {
      if (csi < 0.2) return "very_low";
      if (csi < 0.4) return "low";
      if (csi < 0.6) return "medium";
      if (csi < 0.8) return "high";
      return "very_high";
    }

    function classifyFragility(value) {
      if (value <= 0.25) return "very_low";
      if (value <= 0.45) return "low";
      if (value <= 0.6) return "moderate";
      if (value <= 0.75) return "high";
      return "very_high";
    }

    function getFeatureCenter(feature) {
      const coords = feature.geometry.coordinates;
      const flat = [];
      function extract(c) {
        if (typeof c[0] === "number") {
          flat.push(c);
        } else {
          c.forEach(extract);
        }
      }
      extract(coords);

      let minX = Infinity,
        minY = Infinity,
        maxX = -Infinity,
        maxY = -Infinity;
      flat.forEach(([x, y]) => {
        if (x < minX) minX = x;
        if (x > maxX) maxX = x;
        if (y < minY) minY = y;
        if (y > maxY) maxY = y;
      });
      return {
        lng: (minX + maxX) / 2,
        lat: (minY + maxY) / 2,
      };
    }

    /* =====================
       5. Mappe
    ====================== */
    function initMapCSI() {
      mapCSI = new maplibregl.Map({
        container: "map-csi",
        style: BASEMAP_STYLE,
        center: [11.34, 44.5],
        zoom: 11.8,
      });
      mapCSI.addControl(new maplibregl.NavigationControl(), "top-right");

      mapCSI.on("load", () => {
        mapCSI.addSource("csi-areas", { type: "geojson", data: csiData });

        const csiValues = csiData.features
          .map((f) => toNum(f.properties.CSI_avg))
          .filter((v) => !isNaN(v));
        const csiMin = Math.min(...csiValues);
        const csiMax = Math.max(...csiValues);
        const span = csiMax - csiMin || 1;
        const q1 = csiMin + span * 0.25;
        const q2 = csiMin + span * 0.5;
        const q3 = csiMin + span * 0.75;

        csiStats = { min: csiMin, max: csiMax, q1, q2, q3 };

        mapCSI.addLayer({
          id: "csi-areas-fill",
          type: "fill",
          source: "csi-areas",
          paint: {
            "fill-color": [
              "interpolate",
              ["linear"],
              ["to-number", ["get", "CSI_avg"]],
              csiMin, "#ecfdf3",
              q1, "#bbf7d0",
              q2, "#86efac",
              q3, "#22c55e",
              csiMax, "#166534",
            ],
            "fill-opacity": 0.75,
            "fill-outline-color": "#ffffff",
          },
        });

        mapCSI.addLayer({
          id: "csi-areas-highlight",
          type: "line",
          source: "csi-areas",
          paint: {
            "line-color": "#111827",
            "line-width": 2,
          },
          filter: ["==", ["get", "area_stati"], "__none__"],
        });

        // Slider opacit√† CSI
        const opacitySliderCSI = document.getElementById("opacity-csi");
        if (opacitySliderCSI) {
          const updateCSIOpacity = () => {
            const v = parseFloat(opacitySliderCSI.value);
            mapCSI.setPaintProperty("csi-areas-fill", "fill-opacity", v);
          };
          opacitySliderCSI.addEventListener("input", updateCSIOpacity);
          updateCSIOpacity();
        }

        const popup = new maplibregl.Popup({
          closeButton: false,
          closeOnClick: false,
        });

        mapCSI.on("mousemove", "csi-areas-fill", (e) => {
          const f = e.features[0];
          const p = f.properties;
          const t = I18N[currentLang];

          const html = `
            <strong>${p.area_stati || p.zona || t?.popupPark || "Area"}</strong><br/>
            ${t?.popupCSI || "CSI"}: ${
              p.CSI_avg !== undefined ? toNum(p.CSI_avg).toFixed(3) : "n.d."
            }<br/>
            CS: ${p.CS ?? "n.d."} (n. climate shelters)<br/>
            green: ${
              p["green%"] !== undefined ? toNum(p["green%"]).toFixed(1) : "n.d."
            }% ¬∑
            blue: ${
              p["blue%"] !== undefined ? toNum(p["blue%"]).toFixed(1) : "n.d."
            }%<br/>
            hot: ${
              p["hot_area%"] !== undefined
                ? toNum(p["hot_area%"]).toFixed(1)
                : "n.d."
            }% ¬∑
            cold: ${
              p["cold_area%"] !== undefined
                ? toNum(p["cold_area%"]).toFixed(1)
                : "n.d."
            }%
          `;
          popup.setLngLat(e.lngLat).setHTML(html).addTo(mapCSI);
        });

        mapCSI.on("mouseleave", "csi-areas-fill", () => popup.remove());
      });
    }

    function applyCSIFilter(cls) {
      if (!mapCSI) return;
      if (cls === "all") {
        mapCSI.setFilter("csi-areas-fill", null);
      } else {
        mapCSI.setFilter("csi-areas-fill", ["==", ["get", "csi_class"], cls]);
      }
    }

    function initCSIFilterUI() {
      document.querySelectorAll("#csi-filters .chip").forEach((chip) => {
        chip.addEventListener("click", () => {
          document.querySelectorAll("#csi-filters .chip").forEach((c) => {
            c.classList.remove("active");
          });
          chip.classList.add("active");
          applyCSIFilter(chip.dataset.class);
        });
      });
    }

    function initMapCFI() {
      mapCFI = new maplibregl.Map({
        container: "map-cfi",
        style: BASEMAP_STYLE,
        center: [11.34, 44.5],
        zoom: 11.4,
      });
      mapCFI.addControl(new maplibregl.NavigationControl(), "top-right");

      mapCFI.on("load", () => {
        mapCFI.addSource("cfi-areas", { type: "geojson", data: cfiData });

        const fVals = cfiData.features
          .map((f) => toNum(f.properties.N_frag2))
          .filter((v) => !isNaN(v));
        const fMin = Math.min(...fVals);
        const fMax = Math.max(...fVals);
        const span = fMax - fMin || 1;
        const fq1 = fMin + span * 0.25;
        const fq2 = fMin + span * 0.5;
        const fq3 = fMin + span * 0.75;

        fragStats = { min: fMin, max: fMax, q1: fq1, q2: fq2, q3: fq3 };

        mapCFI.addLayer({
          id: "cfi-fill",
          type: "fill",
          source: "cfi-areas",
          paint: {
            "fill-color": [
              "interpolate",
              ["linear"],
              ["to-number", ["get", "N_frag2"]],
              fMin, "#f5f3ff",
              fq1, "#ddd6fe",
              fq2, "#a5b4fc",
              fq3, "#6366f1",
              fMax, "#4f46e5",
            ],
            "fill-opacity": 0.4,
            "fill-outline-color": "#ffffff",
          },
        });

        mapCFI.addLayer({
          id: "cfi-areas-highlight",
          type: "line",
          source: "cfi-areas",
          paint: {
            "line-color": "#1e1b4b",
            "line-width": 2,
          },
          filter: ["==", ["get", "area_stati"], "__none__"],
        });

        // Slider opacit√† CFI
        const opacitySliderCFI = document.getElementById("opacity-cfi");
        if (opacitySliderCFI) {
          const updateCFIOpacity = () => {
            const v = parseFloat(opacitySliderCFI.value);
            mapCFI.setPaintProperty("cfi-fill", "fill-opacity", v);
          };
          opacitySliderCFI.addEventListener("input", updateCFIOpacity);
          updateCFIOpacity();
        }

        const popup = new maplibregl.Popup({
          closeButton: false,
          closeOnClick: false,
        });

        mapCFI.on("mousemove", "cfi-fill", (e) => {
          const f = e.features[0];
          const p = f.properties;
          const t = I18N[currentLang];

          const html = `
            <strong>${p.area_stati || p.zona || t?.popupAreaStat || "Area"}</strong><br/>
            CFI climatico (N_f_clim): ${
              p.N_f_clim !== undefined ? toNum(p.N_f_clim).toFixed(3) : "n.d."
            }<br/>
            ${t?.popupF || "Fragilit√† complessiva"}: ${
            p.N_frag2 !== undefined ? toNum(p.N_frag2).toFixed(3) : "n.d."
          }<br/>
            ${t?.popupHF || "Quota dovuta al caldo"}: ${
            p.N_f_clim !== undefined ? toNum(p.N_f_clim).toFixed(3) : "n.d."
          }
          `;
          popup.setLngLat(e.lngLat).setHTML(html).addTo(mapCFI);
        });

        mapCFI.on("mouseleave", "cfi-fill", () => popup.remove());
      });
    }

    function initMapCSIParks() {
      mapCSIParks = new maplibregl.Map({
        container: "map-csi-parks",
        style: BASEMAP_STYLE,
        center: [11.34, 44.5],
        zoom: 11.6,
      });

      // controlli standard + fullscreen nativo
      mapCSIParks.addControl(new maplibregl.NavigationControl(), "top-right");
      mapCSIParks.addControl(
        new maplibregl.FullscreenControl({
          container: document.getElementById("map-csi-parks"),
        }),
        "top-right"
      );

      mapCSIParks.on("load", () => {
        mapCSIParks.addSource("csi-parks", {
          type: "geojson",
          data: csiParksData,
        });

        const values = csiParksData.features
          .map((f) => toNum(f.properties.CSI))
          .filter((v) => !isNaN(v));
        const min = Math.min(...values);
        const max = Math.max(...values);
        const span = max - min || 1;
        const q1 = min + span * 0.25;
        const q2 = min + span * 0.5;
        const q3 = min + span * 0.75;

        mapCSIParks.addLayer({
          id: "csi-parks-fill",
          type: "fill",
          source: "csi-parks",
          paint: {
            "fill-color": [
              "interpolate",
              ["linear"],
              ["to-number", ["get", "CSI"]],
              min, "#ecfdf3",
              q1, "#bbf7d0",
              q2, "#86efac",
              q3, "#22c55e",
              max, "#166534",
            ],
            "fill-opacity": 0.55,
            "fill-outline-color": "#064e3b",
          },
        });

        mapCSIParks.addLayer({
          id: "csi-parks-highlight",
          type: "line",
          source: "csi-parks",
          paint: {
            "line-color": "#111827",
            "line-width": 3,
          },
          filter: ["==", ["get", "nome"], "__none__"],
        });

        const popup = new maplibregl.Popup({
          closeButton: false,
          closeOnClick: false,
          maxWidth: "420px",
        });

        mapCSIParks.on("mousemove", "csi-parks-fill", (e) => {
          const f = e.features[0];
          const p = f.properties;
          let rows = "";
          Object.keys(p).forEach((k) => {
            rows += `<tr><td style="padding:2px 4px;"><strong>${k}</strong></td><td style="padding:2px 4px;">${p[k]}</td></tr>`;
          });

          const title = p.nome || "Parco";
          const subtitle = p.ubicazione ? ` (${p.ubicazione})` : "";

          const html = `
            <div style="font-size:0.8rem;">
              <div><strong>${title}</strong>${subtitle}</div>
              <div style="margin-top:4px; max-height:180px; overflow:auto;">
                <table style="border-collapse:collapse; width:100%; font-size:0.75rem;">
                  <tbody>${rows}</tbody>
                </table>
              </div>
            </div>
          `;
          popup.setLngLat(e.lngLat).setHTML(html).addTo(mapCSIParks);
        });

        mapCSIParks.on("mouseleave", "csi-parks-fill", () => popup.remove());

        const toggleBtn = document.getElementById("toggle-csi-parks-layer");
        let visible = true;
        if (toggleBtn) {
          toggleBtn.addEventListener("click", () => {
            visible = !visible;
            mapCSIParks.setLayoutProperty(
              "csi-parks-fill",
              "visibility",
              visible ? "visible" : "none"
            );
            mapCSIParks.setLayoutProperty(
              "csi-parks-highlight",
              "visibility",
              visible ? "visible" : "none"
            );
            toggleBtn.classList.toggle("off", !visible);
            toggleBtn.textContent = visible
              ? (I18N[currentLang]?.parksToggleLayer || "Nascondi layer")
              : (I18N[currentLang]?.parksShowLayer || "Mostra layer");
          });
        }
      });
    }

    /* =====================
       6. Grafici
    ====================== */
    function buildCSIHistoChart(features) {
      const t = I18N[currentLang] || {};
      const values = features
        .map((f) => toNum(f.properties.CSI_avg))
        .filter((v) => !isNaN(v));

      if (values.length === 0) return;

      const min = Math.min(...values);
      const max = Math.max(...values);
      const binsCount = 6;

      const span = max - min || 1;
      const binSize = span / binsCount;

      const counts = new Array(binsCount).fill(0);
      values.forEach((v) => {
        let idx = Math.floor((v - min) / binSize);
        if (idx >= binsCount) idx = binsCount - 1;
        if (idx < 0) idx = 0;
        counts[idx]++;
      });

      const labels = [];
      for (let i = 0; i < binsCount; i++) {
        const from = min + binSize * i;
        const to = min + binSize * (i + 1);
        labels.push(`${from.toFixed(2)}‚Äì${to.toFixed(2)}`);
      }

      const colors = [
        "#ecfdf3",
        "#bbf7d0",
        "#86efac",
        "#4ade80",
        "#22c55e",
        "#166534",
      ];

      const ctx = document.getElementById("chart-csi-hist");
      if (csiHistChart) csiHistChart.destroy();

      csiHistChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: t.csiHistDatasetLabel || "Numero di aree",
              data: counts,
              backgroundColor: colors,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } },
        },
      });
    }

    function buildAmenitiesChart(features) {
      const t = I18N[currentLang] || {};
      const total = features.length || 1;

      let sumGreen = 0,
        sumBlue = 0,
        sumHot = 0,
        sumCold = 0;
      features.forEach((f) => {
        const p = f.properties;
        sumGreen += toNum(p["green%"]) || 0;
        sumBlue += toNum(p["blue%"]) || 0;
        sumHot += toNum(p["hot_area%"]) || 0;
        sumCold += toNum(p["cold_area%"]) || 0;
      });

      const avgGreen = sumGreen / total;
      const avgBlue = sumBlue / total;
      const avgHot = sumHot / total;
      const avgCold = sumCold / total;

      const ctx = document.getElementById("chart-amenities");
      amenitiesChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: t.amenitiesLabels || ["green", "blue", "hot", "cold"],
          datasets: [
            {
              label: t.amenitiesDatasetLabel || "Valori medi (%)",
              data: [avgGreen, avgBlue, avgHot, avgCold],
              backgroundColor: [
                "#16a34a", // green
                "#2563eb", // blue
                "#f97316", // hot
                "#22d3ee", // cold
              ],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { callback: (v) => v + "%" },
            },
          },
        },
      });
    }

    function buildCFIvCSIChart() {
      const t = I18N[currentLang] || {};
      const ctx = document.getElementById("chart-cfi-vs-csi");

      const points = cfiData.features
        .filter(
          (f) => f.properties.N_f_clim != null && f.properties.CSI_avg != null
        )
        .map((f) => ({
          x: toNum(f.properties.N_f_clim),
          y: toNum(f.properties.CSI_avg),
        }));

      cfiVsCsiChart = new Chart(ctx, {
        type: "scatter",
        data: {
          datasets: [
            {
              label: "Aree",
              data: points,
              pointRadius: 3,
              backgroundColor: "#0b7a4b",
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              title: {
                text:
                  t.cfiVsCsiLabelX ||
                  "CFI climatico (quota dovuta al caldo, N_f_clim)",
                display: true,
              },
              min: 0,
              max: 1,
            },
            y: {
              title: {
                text: t.cfiVsCsiLabelY || "CSI medio dei rifugi climatici",
                display: true,
              },
              min: 0,
              max: 1,
            },
          },
        },
      });
    }

    function buildFragilityClassChart() {
      const t = I18N[currentLang] || {};
      const counts = {
        very_low: 0,
        low: 0,
        moderate: 0,
        high: 0,
        very_high: 0,
      };

      cfiData.features.forEach((f) => {
        const F = toNum(f.properties.N_frag2);
        if (!isNaN(F)) {
          counts[classifyFragility(F)]++;
        }
      });

      const ctx = document.getElementById("chart-fragility-classes");
      fragilityClassChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels:
            t.fragilityClassLabels ||
            ["molto bassa", "bassa", "moderata", "alta", "molto alta"],
          datasets: [
            {
              label: "Aree",
              data: [
                counts.very_low,
                counts.low,
                counts.moderate,
                counts.high,
                counts.very_high,
              ],
              backgroundColor: [
                "#f5f3ff", // molto bassa
                "#ddd6fe", // bassa
                "#a5b4fc", // moderata
                "#6366f1", // alta
                "#4f46e5", // molto alta
              ],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } },
        },
      });
    }

    function updateChartsLanguage() {
      if (!I18N[currentLang]) return;
      const t = I18N[currentLang];

      if (csiHistChart) {
        csiHistChart.data.datasets[0].label =
          t.csiHistDatasetLabel || "Numero di aree";
        csiHistChart.update();
      }
      if (amenitiesChart) {
        amenitiesChart.data.labels =
          t.amenitiesLabels || ["green", "blue", "hot", "cold"];
        amenitiesChart.data.datasets[0].label =
          t.amenitiesDatasetLabel || "Valori medi (%)";
        amenitiesChart.update();
      }
      if (cfiVsCsiChart) {
        cfiVsCsiChart.options.scales.x.title.text =
          t.cfiVsCsiLabelX ||
          "CFI climatico (quota dovuta al caldo, N_f_clim)";
        cfiVsCsiChart.options.scales.y.title.text =
          t.cfiVsCsiLabelY || "CSI medio dei rifugi climatici";
        cfiVsCsiChart.update();
      }
      if (fragilityClassChart) {
        fragilityClassChart.data.labels =
          t.fragilityClassLabels ||
          ["molto bassa", "bassa", "moderata", "alta", "molto alta"];
        fragilityClassChart.update();
      }
    }

    /* =====================
       7. Mappa compare CSI/CFI
    ====================== */
    function getCSIColorExpressionForCompare() {
      if (!csiStats) {
        return [
          "interpolate",
          ["linear"],
          ["to-number", ["get", "CSI_avg"]],
          0.0, "#ecfdf3",
          0.25, "#bbf7d0",
          0.5, "#86efac",
          0.75, "#22c55e",
          1.0, "#166534",
        ];
      }
      const { min, max, q1, q2, q3 } = csiStats;
      return [
        "interpolate",
        ["linear"],
        ["to-number", ["get", "CSI_avg"]],
        min, "#ecfdf3",
        q1, "#bbf7d0",
        q2, "#86efac",
        q3, "#22c55e",
        max, "#166534",
      ];
    }

    function getFragColorExpressionForCompare() {
      if (!fragStats) {
        return [
          "interpolate",
          ["linear"],
          ["to-number", ["get", "N_frag2"]],
          0.0, "#f5f3ff",
          0.25, "#ddd6fe",
          0.5, "#a5b4fc",
          0.75, "#6366f1",
          1.0, "#4f46e5",
        ];
      }
      const { min, max, q1, q2, q3 } = fragStats;
      return [
        "interpolate",
        ["linear"],
        ["to-number", ["get", "N_frag2"]],
        min, "#f5f3ff",
        q1, "#ddd6fe",
        q2, "#a5b4fc",
        q3, "#6366f1",
        max, "#4f46e5",
      ];
    }

    function initCompareMap() {
      mapCompare = new maplibregl.Map({
        container: "map-compare",
        style: BASEMAP_STYLE,
        center: [11.34, 44.5],
        zoom: 11.5,
      });
      mapCompare.addControl(new maplibregl.NavigationControl(), "top-right");

      mapCompare.on("load", () => {
        mapCompare.addSource("csi-areas-full", {
          type: "geojson",
          data: csiData,
        });
        mapCompare.addSource("cfi-areas-full", {
          type: "geojson",
          data: cfiData,
        });

        mapCompare.addLayer({
          id: "csi-areas-full-fill",
          type: "fill",
          source: "csi-areas-full",
          paint: {
            "fill-color": getCSIColorExpressionForCompare(),
            "fill-opacity": 0.5,
            "fill-outline-color": "#0f172a",
          },
        });

        mapCompare.addLayer({
          id: "cfi-areas-full-fill",
          type: "fill",
          source: "cfi-areas-full",
          paint: {
            "fill-color": getFragColorExpressionForCompare(),
            "fill-opacity": 0.5,
            "fill-outline-color": "#020617",
          },
        });

        const slider = document.getElementById("compare-slider");
        const updateOpacity = () => {
          const v = parseFloat(slider.value);
          const cfiOpacity = v;
          const csiOpacity = 1 - v;
          mapCompare.setPaintProperty(
            "csi-areas-full-fill",
            "fill-opacity",
            csiOpacity * 0.8
          );
          mapCompare.setPaintProperty(
            "cfi-areas-full-fill",
            "fill-opacity",
            cfiOpacity * 0.8
          );
        };

        slider.addEventListener("input", updateOpacity);
        updateOpacity();

        const popup = new maplibregl.Popup({
          closeButton: false,
          closeOnClick: false,
        });

        mapCompare.on("mousemove", "cfi-areas-full-fill", (e) => {
          const f = e.features[0];
          const p = f.properties;
          const html = `
            <strong>${p.area_stati || p.zona || "Area"}</strong><br/>
            CSI medio: ${
              p.CSI_avg !== undefined ? toNum(p.CSI_avg).toFixed(3) : "n.d."
            }<br/>
            N_frag2 (F complessiva): ${
              p.N_frag2 !== undefined ? toNum(p.N_frag2).toFixed(3) : "n.d."
            }<br/>
            N_f_clim (CFI): ${
              p.N_f_clim !== undefined ? toNum(p.N_f_clim).toFixed(3) : "n.d."
            }
          `;
          popup.setLngLat(e.lngLat).setHTML(html).addTo(mapCompare);
        });
        mapCompare.on("mouseleave", "cfi-areas-full-fill", () => popup.remove());
      });
    }

    function openFullscreenCompare() {
      const overlay = document.getElementById("fullscreen-compare");
      overlay.classList.add("active");
      if (!mapCompare) {
        initCompareMap();
      } else {
        setTimeout(() => mapCompare.resize(), 200);
      }
    }

    function closeFullscreenCompare() {
      const overlay = document.getElementById("fullscreen-compare");
      overlay.classList.remove("active");
    }

    function initCompareUI() {
      const openBtn = document.getElementById("open-compare");
      const closeBtn = document.getElementById("close-compare");
      if (openBtn) openBtn.addEventListener("click", openFullscreenCompare);
      if (closeBtn) closeBtn.addEventListener("click", closeFullscreenCompare);
    }

    /* =====================
       8. Tabs
    ====================== */
    function initTabs() {
      const buttons = document.querySelectorAll(".tab-btn");
      const panels = document.querySelectorAll(".tab-panel");

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const targetId = btn.dataset.tab;
          buttons.forEach((b) => b.classList.remove("active"));
          panels.forEach((p) => p.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById(targetId).classList.add("active");

          if (targetId === "tab-csi" && mapCSI) mapCSI.resize();
          if (targetId === "tab-cfi" && mapCFI) mapCFI.resize();
        });
      });
    }

    /* =====================
       9. Tabelle (parks, CSI areas, CFI areas)
    ====================== */
    function buildParksTable() {
      const rows = csiParksData.features.map((f, idx) => {
        const p = f.properties;
        return [
          idx,
          p.quart || "",
          p.nome || "",
          p.ubicazione || "",
          p.classe_uni || "",
          isNaN(toNum(p.NDVI)) ? "" : toNum(p.NDVI).toFixed(3),
          isNaN(toNum(p.access_ind)) ? "" : toNum(p.access_ind).toFixed(3),
          isNaN(toNum(p.CSI)) ? "" : toNum(p.CSI).toFixed(3),
          isNaN(toNum(p.area_Ha)) ? "" : toNum(p.area_Ha).toFixed(3),
          p.busstop5 ?? "",
          p.picnic_tab ?? "",
          p.benches ?? "",
        ];
      });

      parksTable = $("#parks-table").DataTable({
        data: rows,
        pageLength: 10,
        lengthChange: false,
        ordering: true,
        searching: true,
        columnDefs: [
          {
            targets: 0,
            visible: false,
            searchable: false,
          },
        ],
        language: currentLang === "it" ? dtLangIt : dtLangEn,
      });

      $("#parks-table tbody").on("click", "tr", function () {
        const data = parksTable.row(this).data();
        if (!data) return;
        const featIndex = data[0];
        const feat = csiParksData.features[featIndex];
        if (!feat || !mapCSIParks) return;

        const center = getFeatureCenter(feat);
        mapCSIParks.flyTo({
          center: [center.lng, center.lat],
          zoom: 14,
        });

        if (mapCSIParks.getLayer("csi-parks-highlight")) {
          const name = feat.properties.nome || "__none__";
          mapCSIParks.setFilter("csi-parks-highlight", [
            "==",
            ["get", "nome"],
            name,
          ]);
        }
      });
    }

    function buildCSIAreasTable() {
      const rows = csiData.features.map((f, idx) => {
        const p = f.properties;
        const areaName = p.area_stati || p.zona || "";
        return [
          idx,
          areaName,
          isNaN(toNum(p.CSI_avg)) ? "" : toNum(p.CSI_avg).toFixed(3),
          p.CS ?? "",
          isNaN(toNum(p["green%"])) ? "" : toNum(p["green%"]).toFixed(1),
          isNaN(toNum(p["blue%"])) ? "" : toNum(p["blue%"]).toFixed(1),
          isNaN(toNum(p["hot_area%"])) ? "" : toNum(p["hot_area%"]).toFixed(1),
          isNaN(toNum(p["cold_area%"])) ? "" : toNum(p["cold_area%"]).toFixed(1),
        ];
      });

      csiAreasTable = $("#csi-areas-table").DataTable({
        data: rows,
        pageLength: 10,
        lengthChange: false,
        ordering: true,
        searching: true,
        columnDefs: [
          {
            targets: 0,
            visible: false,
            searchable: false,
          },
        ],
        language: currentLang === "it" ? dtLangIt : dtLangEn,
      });

      $("#csi-areas-table tbody").on("click", "tr", function () {
        const data = csiAreasTable.row(this).data();
        if (!data) return;
        const idx = data[0];
        const feat = csiData.features[idx];
        if (!feat || !mapCSI) return;

        const center = getFeatureCenter(feat);
        mapCSI.flyTo({
          center: [center.lng, center.lat],
          zoom: 13,
        });

        const name = feat.properties.area_stati || feat.properties.zona || "__none__";
        if (mapCSI.getLayer("csi-areas-highlight")) {
          mapCSI.setFilter("csi-areas-highlight", [
            "any",
            ["==", ["get", "area_stati"], name],
            ["==", ["get", "zona"], name],
          ]);
        }
      });
    }

    function buildCFIAreasTable() {
      const rows = cfiData.features.map((f, idx) => {
        const p = f.properties;
        const areaName = p.area_stati || p.zona || "";
        const F = toNum(p.N_frag2);
        const clsKey = classifyFragility(F);
        let clsLabel = "";
        if (clsKey === "very_low") clsLabel = "molto bassa";
        else if (clsKey === "low") clsLabel = "bassa";
        else if (clsKey === "moderate") clsLabel = "moderata";
        else if (clsKey === "high") clsLabel = "alta";
        else if (clsKey === "very_high") clsLabel = "molto alta";

        return [
          idx,
          areaName,
          isNaN(toNum(p.N_f_clim)) ? "" : toNum(p.N_f_clim).toFixed(3),
          isNaN(F) ? "" : F.toFixed(3),
          clsLabel,
        ];
      });

      cfiAreasTable = $("#cfi-areas-table").DataTable({
        data: rows,
        pageLength: 10,
        lengthChange: false,
        ordering: true,
        searching: true,
        columnDefs: [
          {
            targets: 0,
            visible: false,
            searchable: false,
          },
        ],
        language: currentLang === "it" ? dtLangIt : dtLangEn,
      });

      $("#cfi-areas-table tbody").on("click", "tr", function () {
        const data = cfiAreasTable.row(this).data();
        if (!data) return;
        const idx = data[0];
        const feat = cfiData.features[idx];
        if (!feat || !mapCFI) return;

        const center = getFeatureCenter(feat);
        mapCFI.flyTo({
          center: [center.lng, center.lat],
          zoom: 13,
        });

        const name = feat.properties.area_stati || feat.properties.zona || "__none__";
        if (mapCFI.getLayer("cfi-areas-highlight")) {
          mapCFI.setFilter("cfi-areas-highlight", [
            "any",
            ["==", ["get", "area_stati"], name],
            ["==", ["get", "zona"], name],
          ]);
        }
      });
    }

    function updateTablesLanguage() {
      const lang = currentLang === "it" ? dtLangIt : dtLangEn;
      if (parksTable) parksTable.settings()[0].oLanguage = lang;
      if (csiAreasTable) csiAreasTable.settings()[0].oLanguage = lang;
      if (cfiAreasTable) cfiAreasTable.settings()[0].oLanguage = lang;
      if (parksTable) parksTable.draw(false);
      if (csiAreasTable) csiAreasTable.draw(false);
      if (cfiAreasTable) cfiAreasTable.draw(false);
    }

    /* =====================
       10. Fullscreen mappa parchi (usa controllo nativo)
    ====================== */
    function initParksFullscreen() {
      const btn = document.getElementById("fullscreen-csi-parks");
      if (!btn) return;

      btn.addEventListener("click", () => {
        const fsButton = document.querySelector(
          "#map-csi-parks .maplibregl-ctrl-fullscreen"
        );
        if (fsButton) {
          fsButton.click();
        }
      });
    }

    /* =====================
       11. Modal info
    ====================== */
    function initInfoModal() {
      const modal = document.getElementById("info-modal");
      const openBtn = document.getElementById("open-info-modal");
      const closeBtn = document.getElementById("close-info-modal");

      if (openBtn) {
        openBtn.addEventListener("click", () => {
          modal.classList.add("active");
        });
      }
      if (closeBtn) {
        closeBtn.addEventListener("click", () => {
          modal.classList.remove("active");
        });
      }
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.classList.remove("active");
        }
      });
    }

    /* =====================
       12. Init pagina
    ====================== */
    async function initPage() {
      await loadI18n();

      const [csiResp, cfiResp, csiParksResp] = await Promise.all([
        fetch(CSI_GEOJSON_URL),
        fetch(CFI_GEOJSON_URL),
        fetch(CSI_PARKS_GEOJSON_URL),
      ]);

      const rawCSI = await csiResp.json();
      const rawCFI = await cfiResp.json();
      const rawParks = await csiParksResp.json();

      csiData = rawCSI;
      cfiData = rawCFI;

      if (rawParks.type === "Topology") {
        const firstObjName = Object.keys(rawParks.objects)[0];
        csiParksData = topojson.feature(rawParks, rawParks.objects[firstObjName]);
      } else {
        csiParksData = rawParks;
      }

      csiData.features.forEach((f) => {
        f.properties.csi_class = classifyCSI(toNum(f.properties.CSI_avg));
      });

      document.getElementById("stat-total-parks").textContent =
        csiParksData.features.length;

      const eligible = csiParksData.features.filter(
        (f) => (toNum(f.properties.CSI) || 0) > 0
      );
      document.getElementById("stat-csi-eligible").textContent =
        eligible.length;

      initLangSwitch();
      initTabs();
      initCSIFilterUI();
      initCompareUI();
      initInfoModal();

      initMapCSI();
      initMapCFI();
      initMapCSIParks();
      initParksFullscreen();

      buildCSIHistoChart(csiData.features);
      buildAmenitiesChart(csiData.features);
      buildCFIvCSIChart();
      buildFragilityClassChart();

      buildParksTable();
      buildCSIAreasTable();
      buildCFIAreasTable();

      applyI18n();
      updateLanguageButtons();
      updateChartsLanguage();
      updateTablesLanguage();
    }

    initPage().catch(console.error);
  </script>
</body>
</html>
