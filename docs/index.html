<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Rifugi climatici & fragilità urbana – TALEA / SUOA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MapLibre -->
  <link
    href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --talea-green: #0b7a4b;
      --talea-blue:  #0086c9;
      --talea-yellow:#ffcc33;
      --bg-light:    #f5f7fb;
      --text-main:   #1f2933;
      --text-muted:  #6b778c;
      --card-radius: 14px;
      --shadow-soft: 0 2px 6px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg-light);
      color: var(--text-main);
    }

    /* Topbar stile SUOA */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 1.5rem;
      background: #ffffff;
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-pill {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #ffffff 0, #ffffff 20%, var(--talea-green) 75%);
      border: 2px solid var(--talea-green);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #ffffff;
      font-size: 0.9rem;
    }

    .topbar-title {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-main);
    }

    .topbar-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .topbar-right {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    header.hero {
      padding: 1.5rem 1.5rem 0.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    header.hero h1 {
      margin: 0;
      font-size: 1.55rem;
      color: var(--talea-blue);
    }

    header.hero p {
      margin: 0.4rem 0 0.2rem;
      color: var(--text-muted);
      font-size: 0.95rem;
      max-width: 820px;
    }

    .hero-tagline {
      font-size: 0.85rem;
      color: var(--talea-green);
      margin-top: 0.4rem;
    }

    main.container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem 2rem;
    }

    /* Hero cards con numeri chiave */
    .hero-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-top: 1rem;
      margin-bottom: 1rem;
    }

    .hero-card {
      background: #ffffff;
      border-radius: var(--card-radius);
      padding: 0.9rem 1rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.25);
      position: relative;
      overflow: hidden;
    }

    .hero-card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 2px solid transparent;
      border-image: linear-gradient(
          135deg,
          rgba(11, 122, 75, 0.2),
          rgba(0, 134, 201, 0.2),
          rgba(255, 204, 51, 0.4)
        )
        1;
      opacity: 0.9;
      pointer-events: none;
    }

    .hero-card span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .hero-card h2 {
      margin: 0.25rem 0;
      font-size: 1.7rem;
      color: var(--talea-green);
    }

    .hero-card small {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Tabs CSI / Fragilità */
    .tabs {
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      display: inline-flex;
      border-radius: 999px;
      padding: 0.15rem;
      background: #e5edf9;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 0.35rem 0.95rem;
      font-size: 0.85rem;
      border-radius: 999px;
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .tab-btn span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.25);
    }

    .tab-btn.active {
      background: #ffffff;
      color: var(--talea-blue);
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.12);
    }

    .tab-btn.active span.dot {
      background: var(--talea-green);
    }

    .section-title {
      margin: 1.5rem 0 0.2rem;
      font-size: 1.25rem;
      color: var(--talea-blue);
    }

    .section-subtitle {
      margin: 0 0 0.8rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .two-columns {
      display: grid;
      grid-template-columns: 2fr 1.5fr;
      gap: 1rem;
      align-items: stretch;
    }

    .card {
      background: #ffffff;
      border-radius: var(--card-radius);
      padding: 1rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.35);
      height: 100%;
    }

    #map-csi,
    #map-cfi {
      width: 100%;
      height: 420px;
      border-radius: 10px;
      overflow: hidden;
    }

    canvas {
      max-width: 100%;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
      margin-bottom: 0.75rem;
    }

    .chip {
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.8rem;
      cursor: pointer;
      background: #f9fafb;
      color: var(--text-muted);
    }

    .chip.active {
      background: var(--talea-green);
      color: #ffffff;
      border-color: var(--talea-green);
    }

    .card h3 {
      margin: 0;
      font-size: 0.95rem;
      color: var(--talea-blue);
    }

    .card hr {
      border: none;
      border-top: 1px solid rgba(148, 163, 184, 0.35);
      margin: 0.8rem 0;
    }

    .hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.4rem;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    @media (max-width: 900px) {
      header.hero,
      main.container {
        padding: 0.75rem 1rem 1.5rem;
      }

      .hero-grid {
        grid-template-columns: 1fr;
      }

      .two-columns {
        grid-template-columns: 1fr;
      }

      #map-csi,
      #map-cfi {
        height: 320px;
      }
    }
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-left">
      <div class="logo-pill">TA</div>
      <div>
        <div class="topbar-title">TALEA · Systemic Urban Observation Atlas</div>
        <div class="topbar-subtitle">Climate shelters & fragility · Bologna case</div>
      </div>
    </div>
    <div class="topbar-right">
      <span>Digital Commons Lab · FBK</span>
    </div>
  </div>

  <!-- HERO -->
  <header class="hero">
    <h1>Rifugi climatici & fragilità urbana</h1>
    <p>
      Bologna come laboratorio per capire cosa rende efficace un rifugio climatico,
      come si intreccia con la fragilità urbana e come TALEA può guidare le scelte
      di pianificazione.
    </p>
    <div class="hero-tagline">
      Dal verde generico ai climate shelters: dati, mappe e storie per il SUOA.
    </div>
  </header>

  <main class="container">
    <!-- NUMERI CHIAVE -->
    <section>
      <div class="hero-grid">
        <div class="hero-card">
          <span>Spazi verdi analizzati</span>
          <h2 id="stat-total-parks">727</h2>
          <small>aree verdi pubbliche considerate nel modello CSI</small>
        </div>
        <div class="hero-card">
          <span>Candidati rifugi climatici</span>
          <h2 id="stat-csi-eligible">181</h2>
          <small>superficie &gt; 0.5 ha e NDVI &gt; 0.4</small>
        </div>
        <div class="hero-card">
          <span>Range osservato CFI</span>
          <h2>0.18 – 0.81</h2>
          <small>fragilità climatica normalizzata per area statistica</small>
        </div>
      </div>
    </section>

    <!-- TABS -->
    <section>
      <div class="tabs">
        <button class="tab-btn active" data-tab="tab-csi">
          <span class="dot"></span>
          Rifugi climatici (CSI)
        </button>
        <button class="tab-btn" data-tab="tab-cfi">
          <span class="dot"></span>
          Fragilità & accesso ai rifugi
        </button>
      </div>
    </section>

    <!-- TAB CSI -->
    <section id="tab-csi" class="tab-panel active">
      <h2 class="section-title">Dove sono e come funzionano i rifugi climatici</h2>
      <p class="section-subtitle">
        Non tutti i parchi sono rifugi climatici: qui vediamo qualità (CSI), dotazioni
        e accessibilità dei green spaces bolognesi.
      </p>

      <div class="two-columns">
        <div class="card">
          <div class="filters" id="csi-filters">
            <div class="chip active" data-class="all">Tutti</div>
            <div class="chip" data-class="very_low">CSI molto basso</div>
            <div class="chip" data-class="low">CSI basso</div>
            <div class="chip" data-class="medium">CSI medio</div>
            <div class="chip" data-class="high">CSI alto</div>
            <div class="chip" data-class="very_high">CSI molto alto</div>
          </div>
          <div id="map-csi"></div>
          <div class="hint">
            Suggerimento: usa i filtri per concentrarti sui parchi con migliore
            capacità di offrire sollievo (CSI alto/molto alto).
          </div>
        </div>
        <div class="card">
          <h3>Distribuzione del Climate Shelter Index (CSI)</h3>
          <canvas id="chart-csi-hist"></canvas>
          <div class="hint">
            Quanti parchi hanno davvero un CSI elevato? L’istogramma mostra quante
            aree verdi rientrano in ciascuna classe di qualità climatica.
          </div>
          <hr />
          <h3>Dotazioni dei rifugi</h3>
          <canvas id="chart-amenities"></canvas>
          <div class="hint">
            Fontane, panchine e tavoli sono elementi essenziali di un rifugio
            climatico: qui vedi in quanti parchi sono presenti.
          </div>
        </div>
      </div>
    </section>

    <!-- TAB CFI -->
    <section id="tab-cfi" class="tab-panel">
      <h2 class="section-title">Fragilità climatica e sociale per quartiere</h2>
      <p class="section-subtitle">
        Le aree più fragili combinano esposizione al calore, scarsa presenza di rifugi
        climatici e vulnerabilità socio-economica. Qui vediamo come questi fattori si
        intrecciano nello spazio urbano.
      </p>

      <div class="two-columns">
        <div class="card">
          <div id="map-cfi"></div>
          <div class="hint">
            Passa il mouse sulle aree statistiche per leggere CFI (fragilità
            climatica), F complessivo e HF. La mappa evidenzia le zone a priorità
            maggiore.
          </div>
        </div>
        <div class="card">
          <h3>CFI vs qualità dei rifugi (CSI medio)</h3>
          <canvas id="chart-cfi-vs-csi"></canvas>
          <div class="hint">
            Ogni punto è un’area statistica: in alto a sinistra trovi le zone con
            alta fragilità climatica e rifugi di bassa qualità — i candidati naturali
            per interventi TALEA.
          </div>
          <hr />
          <h3>Classi di fragilità complessiva (F)</h3>
          <canvas id="chart-fragility-classes"></canvas>
          <div class="hint">
            La distribuzione per classi mostra quanto la fragilità climatica
            contribuisce a spostare i quartieri verso livelli di rischio più elevati.
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // === CONFIG: sostituisci con i percorsi reali dei tuoi file ===
    const CSI_GEOJSON_URL = "data/Climatic_fragility/outputs/green_spaces_csi.geojson";
    const CFI_GEOJSON_URL = "data/Climatic_fragility/outputs/fragility_areas.geojson";

    let csiData = null;
    let cfiData = null;
    let mapCSI, mapCFI;
    let csiHistChart, amenitiesChart, cfiVsCsiChart, fragilityClassChart;

    // Classifica CSI in 5 classi
    function classifyCSI(csi) {
      if (csi < 0.2) return "very_low";
      if (csi < 0.4) return "low";
      if (csi < 0.6) return "medium";
      if (csi < 0.8) return "high";
      return "very_high";
    }

    // Classi di fragilità complessiva F (esempio coerente con CFI)
    function classifyFragility(value) {
      if (value <= 0.25) return "very_low";
      if (value <= 0.45) return "low";
      if (value <= 0.6) return "moderate";
      if (value <= 0.75) return "high";
      return "very_high";
    }

    // Inizializza mappa CSI
    function initMapCSI() {
      mapCSI = new maplibregl.Map({
        container: "map-csi",
        style: "https://demotiles.maplibre.org/style.json",
        center: [11.34, 44.5],
        zoom: 11.8,
      });

      mapCSI.addControl(new maplibregl.NavigationControl(), "top-right");

      mapCSI.on("load", () => {
        mapCSI.addSource("csi-parks", {
          type: "geojson",
          data: csiData,
        });

        mapCSI.addLayer({
          id: "csi-parks-layer",
          type: "circle",
          source: "csi-parks",
          paint: {
            "circle-radius": [
              "interpolate",
              ["linear"],
              ["get", "area_ha"],
              0.5, 4,
              5, 12,
            ],
            "circle-color": [
              "interpolate",
              ["linear"],
              ["get", "csi"],
              0, "#e5e7eb",
              0.2, "#c7f2d2",
              0.4, "#7dd3a5",
              0.6, "#22c55e",
              0.8, "#15803d",
            ],
            "circle-opacity": 0.9,
            "circle-stroke-color": "#ffffff",
            "circle-stroke-width": 1,
          },
        });

        const popup = new maplibregl.Popup({
          closeButton: false,
          closeOnClick: false,
        });

        mapCSI.on("mousemove", "csi-parks-layer", (e) => {
          const f = e.features[0];
          const p = f.properties;
          const html = `
            <strong>${p.name || "Parco"}</strong><br/>
            CSI: ${p.csi !== undefined ? (+p.csi).toFixed(2) : "n.d."}<br/>
            NDVI: ${p.ndvi !== undefined ? (+p.ndvi).toFixed(2) : "n.d."}<br/>
            Fontane: ${p.fountain ? "sì" : "no"} · Panchine: ${
            p.benches ? "sì" : "no"
          }<br/>
            Tavoli: ${p.tables ? "sì" : "no"}
          `;
          popup.setLngLat(e.lngLat).setHTML(html).addTo(mapCSI);
        });

        mapCSI.on("mouseleave", "csi-parks-layer", () => popup.remove());
      });
    }

    // Applica filtro CSI su mappa
    function applyCSIFilter(cls) {
      if (!mapCSI) return;
      if (cls === "all") {
        mapCSI.setFilter("csi-parks-layer", null);
      } else {
        mapCSI.setFilter("csi-parks-layer", ["==", ["get", "csi_class"], cls]);
      }
    }

    // Inizializza mappa CFI
    function initMapCFI() {
      mapCFI = new maplibregl.Map({
        container: "map-cfi",
        style: "https://demotiles.maplibre.org/style.json",
        center: [11.34, 44.5],
        zoom: 11.4,
      });

      mapCFI.addControl(new maplibregl.NavigationControl(), "top-right");

      mapCFI.on("load", () => {
        mapCFI.addSource("cfi-areas", {
          type: "geojson",
          data: cfiData,
        });

        mapCFI.addLayer({
          id: "cfi-fill",
          type: "fill",
          source: "cfi-areas",
          paint: {
            "fill-color": [
              "step",
              ["get", "CFI"],
              "#edf8fb",
              0.25,
              "#b2e2e2",
              0.45,
              "#66c2a4",
              0.6,
              "#2ca25f",
              0.75,
              "#006d2c",
            ],
            "fill-opacity": 0.8,
            "fill-outline-color": "#ffffff",
          },
        });

        const popup = new maplibregl.Popup({
          closeButton: false,
          closeOnClick: false,
        });

        mapCFI.on("mousemove", "cfi-fill", (e) => {
          const f = e.features[0];
          const p = f.properties;
          const html = `
            <strong>${p.name || "Area statistica"}</strong><br/>
            CFI: ${p.CFI !== undefined ? (+p.CFI).toFixed(2) : "n.d."}<br/>
            F: ${p.F !== undefined ? (+p.F).toFixed(2) : "n.d."}<br/>
            HF: ${p.HF !== undefined ? (+p.HF).toFixed(2) : "n.d."}
          `;
          popup.setLngLat(e.lngLat).setHTML(html).addTo(mapCFI);
        });

        mapCFI.on("mouseleave", "cfi-fill", () => popup.remove());
      });
    }

    // Chart: distribuzione CSI
    function buildCSIHistoChart(features) {
      const bins = {
        very_low: 0,
        low: 0,
        medium: 0,
        high: 0,
        very_high: 0,
      };
      features.forEach((f) => {
        bins[f.properties.csi_class] += 1;
      });

      const ctx = document.getElementById("chart-csi-hist");
      csiHistChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: [
            "Molto basso",
            "Basso",
            "Medio",
            "Alto",
            "Molto alto",
          ],
          datasets: [
            {
              label: "N. parchi",
              data: [
                bins.very_low,
                bins.low,
                bins.medium,
                bins.high,
                bins.very_high,
              ],
              backgroundColor: [
                "#e5e7eb",
                "#bae6fd",
                "#7dd3fc",
                "#0ea5e9",
                "#0369a1",
              ],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    }

    // Chart: dotazioni parchi
    function buildAmenitiesChart(features) {
      const total = features.length || 1;
      const counts = { fountain: 0, benches: 0, tables: 0 };
      features.forEach((f) => {
        const p = f.properties;
        if (p.fountain) counts.fountain++;
        if (p.benches) counts.benches++;
        if (p.tables) counts.tables++;
      });

      const ctx = document.getElementById("chart-amenities");
      amenitiesChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Fontane", "Panchine", "Tavoli"],
          datasets: [
            {
              label: "% parchi",
              data: [
                (counts.fountain / total) * 100,
                (counts.benches / total) * 100,
                (counts.tables / total) * 100,
              ],
              backgroundColor: ["#22c55e", "#0ea5e9", "#facc15"],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: (v) => v + "%",
              },
            },
          },
        },
      });
    }

    // Chart: CFI vs CSI medio
    function buildCFIvCSIChart() {
      const ctx = document.getElementById("chart-cfi-vs-csi");
      const points = cfiData.features
        .filter(
          (f) =>
            f.properties.CFI !== null &&
            f.properties.CSI_mean !== null
        )
        .map((f) => ({
          x: +f.properties.CFI,
          y: +f.properties.CSI_mean,
        }));

      cfiVsCsiChart = new Chart(ctx, {
        type: "scatter",
        data: {
          datasets: [
            {
              label: "Aree statistiche",
              data: points,
              pointRadius: 3,
              backgroundColor: "#0ea5e9",
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
          },
          scales: {
            x: {
              title: {
                text: "CFI (fragilità climatica)",
                display: true,
              },
              min: 0,
              max: 1,
            },
            y: {
              title: {
                text: "CSI medio dei parchi",
                display: true,
              },
              min: 0,
              max: 1,
            },
          },
        },
      });
    }

    // Chart: classi di fragilità complessiva F
    function buildFragilityClassChart() {
      const counts = {
        very_low: 0,
        low: 0,
        moderate: 0,
        high: 0,
        very_high: 0,
      };
      cfiData.features.forEach((f) => {
        if (f.properties.F != null) {
          const c = classifyFragility(+f.properties.F);
          counts[c]++;
        }
      });

      const ctx = document.getElementById("chart-fragility-classes");
      fragilityClassChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: [
            "Molto bassa",
            "Bassa",
            "Moderata",
            "Alta",
            "Molto alta",
          ],
          datasets: [
            {
              label: "N. aree",
              data: [
                counts.very_low,
                counts.low,
                counts.moderate,
                counts.high,
                counts.very_high,
              ],
              backgroundColor: [
                "#e5e7eb",
                "#bae6fd",
                "#7dd3fc",
                "#0ea5e9",
                "#0369a1",
              ],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    }

    // UI tabs
    function initTabs() {
      const buttons = document.querySelectorAll(".tab-btn");
      const panels = document.querySelectorAll(".tab-panel");

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const targetId = btn.dataset.tab;

          buttons.forEach((b) => b.classList.remove("active"));
          panels.forEach((p) => p.classList.remove("active"));

          btn.classList.add("active");
          document.getElementById(targetId).classList.add("active");

          // Forza resize delle mappe quando il tab diventa visibile
          if (targetId === "tab-csi" && mapCSI) {
            mapCSI.resize();
          }
          if (targetId === "tab-cfi" && mapCFI) {
            mapCFI.resize();
          }
        });
      });
    }

    // Filtro chips CSI
    function initCSIFilterUI() {
      const chips = document.querySelectorAll("#csi-filters .chip");
      chips.forEach((ch) => {
        ch.addEventListener("click", () => {
          chips.forEach((c) => c.classList.remove("active"));
          ch.classList.add("active");
          const cls = ch.dataset.class;
          applyCSIFilter(cls);
        });
      });
    }

    // Carica dati e inizializza tutto
    async function loadData() {
      const [csiResp, cfiResp] = await Promise.all([
        fetch(CSI_GEOJSON_URL),
        fetch(CFI_GEOJSON_URL),
      ]);
      csiData = await csiResp.json();
      cfiData = await cfiResp.json();

      // Precalcola classi CSI
      csiData.features.forEach((f) => {
        const csi = +f.properties.csi;
        f.properties.csi_class = classifyCSI(csi);
      });

      // Aggiorna numeri hero con dati reali (se vuoi usare le stime del file)
      document.getElementById("stat-total-parks").textContent =
        csiData.features.length;
      const eligible = csiData.features.filter(
        (f) =>
          f.properties.eligible === 1 ||
          f.properties.candidate === 1
      );
      if (eligible.length) {
        document.getElementById("stat-csi-eligible").textContent =
          eligible.length;
      }

      initMapCSI();
      initMapCFI();
      initCSIFilterUI();
      initTabs();

      buildCSIHistoChart(csiData.features);
      buildAmenitiesChart(
        eligible.length ? eligible : csiData.features
      );
      buildCFIvCSIChart();
      buildFragilityClassChart();
    }

    loadData().catch((err) => console.error(err));
  </script>
</body>
</html>

