<script>
/* =========================================================
   1. CARICAMENTO MULTILINGUA DA FILE JSON ESTERNI
   ========================================================= */

let I18N = { it: null, en: null };
let currentLang = "it";

async function loadI18n() {
  const [itResp, enResp] = await Promise.all([
    fetch("assets/i18n/it.json"),
    fetch("assets/i18n/en.json")
  ]);
  I18N.it = await itResp.json();
  I18N.en = await enResp.json();
}

function applyI18n() {
  const t = I18N[currentLang];
  document.querySelectorAll("[data-i18n]").forEach((el) => {
    const key = el.getAttribute("data-i18n");
    if (t[key] !== undefined) {
      el.textContent = t[key];
    }
  });
}

function updateLanguageButtons() {
  document.querySelectorAll(".lang-btn").forEach((btn) => {
    btn.classList.remove("active");
  });
  document
    .querySelector(`.lang-btn[data-lang='${currentLang}']`)
    .classList.add("active");
}

/* =========================================================
   2. CONFIG PERCORSI GEOJSON
   ========================================================= */

const CSI_GEOJSON_URL =
  "data/Climatic_fragility/outputs/green_spaces_csi.geojson";
const CFI_GEOJSON_URL =
  "data/Climatic_fragility/outputs/fragility_areas.geojson";

/* =========================================================
   3. VARIABILI GLOBALI MAPPE + GRAFICI
   ========================================================= */

let csiData = null;
let cfiData = null;
let mapCSI, mapCFI;
let csiHistChart, amenitiesChart, cfiVsCsiChart, fragilityClassChart;

/* =========================================================
   4. CLASSIFICAZIONE VALORI
   ========================================================= */

function classifyCSI(csi) {
  if (csi < 0.2) return "very_low";
  if (csi < 0.4) return "low";
  if (csi < 0.6) return "medium";
  if (csi < 0.8) return "high";
  return "very_high";
}

function classifyFragility(value) {
  if (value <= 0.25) return "very_low";
  if (value <= 0.45) return "low";
  if (value <= 0.6) return "moderate";
  if (value <= 0.75) return "high";
  return "very_high";
}

/* =========================================================
   5. MAPPA CSI
   ========================================================= */

function initMapCSI() {
  mapCSI = new maplibregl.Map({
    container: "map-csi",
    style: "https://demotiles.maplibre.org/style.json",
    center: [11.34, 44.5],
    zoom: 11.8,
  });

  mapCSI.addControl(new maplibregl.NavigationControl(), "top-right");

  mapCSI.on("load", () => {
    mapCSI.addSource("csi-parks", {
      type: "geojson",
      data: csiData,
    });

    mapCSI.addLayer({
      id: "csi-parks-layer",
      type: "circle",
      source: "csi-parks",
      paint: {
        "circle-radius": [
          "interpolate",
          ["linear"],
          ["get", "area_ha"],
          0.5, 4,
          5, 12,
        ],
        "circle-color": [
          "interpolate",
          ["linear"],
          ["get", "csi"],
          0, "#e5e7eb",
          0.2, "#c7f2d2",
          0.4, "#7dd3a5",
          0.6, "#22c55e",
          0.8, "#15803d",
        ],
        "circle-opacity": 0.9,
        "circle-stroke-color": "#ffffff",
        "circle-stroke-width": 1,
      },
    });

    const popup = new maplibregl.Popup({
      closeButton: false,
      closeOnClick: false,
    });

    mapCSI.on("mousemove", "csi-parks-layer", (e) => {
      const f = e.features[0];
      const p = f.properties;
      const t = I18N[currentLang];

      const html = `
        <strong>${p.name || t.popupPark}</strong><br/>
        ${t.popupCSI}: ${p.csi !== undefined ? (+p.csi).toFixed(2) : "n.d."}<br/>
        ${t.popupNDVI}: ${p.ndvi !== undefined ? (+p.ndvi).toFixed(2) : "n.d."}<br/>
        ${t.popupFountains}: ${p.fountain ? "✔" : "—"} ·
        ${t.popupBenches}: ${p.benches ? "✔" : "—"}<br/>
        ${t.popupTables}: ${p.tables ? "✔" : "—"}
      `;
      popup.setLngLat(e.lngLat).setHTML(html).addTo(mapCSI);
    });

    mapCSI.on("mouseleave", "csi-parks-layer", () => popup.remove());
  });
}

function applyCSIFilter(cls) {
  if (!mapCSI) return;
  if (cls === "all") {
    mapCSI.setFilter("csi-parks-layer", null);
  } else {
    mapCSI.setFilter("csi-parks-layer", ["==", ["get", "csi_class"], cls]);
  }
}

/* =========================================================
   6. MAPPA CFI
   ========================================================= */

function initMapCFI() {
  mapCFI = new maplibregl.Map({
    container: "map-cfi",
    style: "https://demotiles.maplibre.org/style.json",
    center: [11.34, 44.5],
    zoom: 11.4,
  });

  mapCFI.addControl(new maplibregl.NavigationControl(), "top-right");

  mapCFI.on("load", () => {
    mapCFI.addSource("cfi-areas", {
      type: "geojson",
      data: cfiData,
    });

    mapCFI.addLayer({
      id: "cfi-fill",
      type: "fill",
      source: "cfi-areas",
      paint: {
        "fill-color": [
          "step",
          ["get", "CFI"],
          "#edf8fb",
          0.25,
          "#b2e2e2",
          0.45,
          "#66c2a4",
          0.6,
          "#2ca25f",
          0.75,
          "#006d2c",
        ],
        "fill-opacity": 0.8,
        "fill-outline-color": "#ffffff",
      },
    });

    const popup = new maplibregl.Popup({
      closeButton: false,
      closeOnClick: false,
    });

    mapCFI.on("mousemove", "cfi-fill", (e) => {
      const f = e.features[0];
      const p = f.properties;
      const t = I18N[currentLang];

      const html = `
        <strong>${p.name || t.popupAreaStat}</strong><br/>
        CFI: ${p.CFI !== undefined ? (+p.CFI).toFixed(2) : "n.d."}<br/>
        ${t.popupF}: ${p.F !== undefined ? (+p.F).toFixed(2) : "n.d."}<br/>
        ${t.popupHF}: ${p.HF !== undefined ? (+p.HF).toFixed(2) : "n.d."}
      `;
      popup.setLngLat(e.lngLat).setHTML(html).addTo(mapCFI);
    });

    mapCFI.on("mouseleave", "cfi-fill", () => popup.remove());
  });
}

/* =========================================================
   7. GRAFICI (aggiornabili a cambio lingua)
   ========================================================= */

function buildCSIHistoChart(features) {
  const t = I18N[currentLang];

  const bins = { very_low: 0, low: 0, medium: 0, high: 0, very_high: 0 };
  features.forEach((f) => bins[f.properties.csi_class]++);

  const ctx = document.getElementById("chart-csi-hist");
  csiHistChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: t.csiHistLabels,
      datasets: [
        {
          label: "N. parchi",
          data: [
            bins.very_low,
            bins.low,
            bins.medium,
            bins.high,
            bins.very_high,
          ],
          backgroundColor: [
            "#e5e7eb",
            "#bae6fd",
            "#7dd3fc",
            "#0ea5e9",
            "#0369a1",
          ],
        },
      ],
    },
    options: { responsive: true, plugins: { legend: { display: false } } },
  });
}

function buildAmenitiesChart(features) {
  const t = I18N[currentLang];
  const total = features.length || 1;
  const counts = { fountain: 0, benches: 0, tables: 0 };

  features.forEach((f) => {
    const p = f.properties;
    if (p.fountain) counts.fountain++;
    if (p.benches) counts.benches++;
    if (p.tables) counts.tables++;
  });

  const ctx = document.getElement => p.tables).filter(f => f.properties.fountain).length.

  const amenitiesChartData = {
    labels: t.amenitiesLabels,
    datasets: [
      {
        label: t.amenitiesDatasetLabel,
        data: [
          (counts.fountain / total) * 100,
          (counts.benches / total) * 100,
          (counts.tables / total) * 100,
        ],
        backgroundColor: ["#22c55e", "#0ea5e9", "#facc15"],
      },
    ],
  };

  const amenitiesChartOpts = {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: {
      y: {
        beginAtZero: true,
        max: 100,
        ticks: {
          callback: (v) => v + "%",
        },
      },
    },
  };

  amenitiesChart = new Chart(
    document.getElementById("chart-amenities"),
    { type: "bar", data: amenitiesChartData, options: amenitiesChartOpts }
  );
}


/* =========================================================
   8. GRAFICO CFI vs CSI medio
   ========================================================= */

function buildCFIvCSIChart() {
  const t = I18N[currentLang];
  const ctx = document.getElementById("chart-cfi-vs-csi");

  const points = cfiData.features
    .filter((f) => f.properties.CFI && f.properties.CSI_mean)
    .map((f) => ({ x: +f.properties.CFI, y: +f.properties.CSI_mean }));

  cfiVsCsiChart = new Chart(ctx, {
    type: "scatter",
    data: {
      datasets: [
        {
          label: "Aree",
          data: points,
          pointRadius: 3,
          backgroundColor: "#0ea5e9",
        },
      ],
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          title: { text: t.cfiVsCsiLabelX, display: true },
          min: 0,
          max: 1,
        },
        y: {
          title: { text: t.cfiVsCsiLabelY, display: true },
          min: 0,
          max: 1,
        },
      },
    },
  });
}

/* =========================================================
   9. GRAFICO CLASSI DI FRAGILITÀ
   ========================================================= */

function buildFragilityClassChart() {
  const t = I18N[currentLang];

  const counts = {
    very_low: 0,
    low: 0,
    moderate: 0,
    high: 0,
    very_high: 0,
  };

  cfiData.features.forEach((f) => {
    if (f.properties.F != null) {
      counts[classifyFragility(+f.properties.F)]++;
    }
  });

  fragilityClassChart = new Chart(
    document.getElementById("chart-fragility-classes"),
    {
      type: "bar",
      data: {
        labels: t.fragilityClassLabels,
        datasets: [
          {
            label: "Aree",
            data: [
              counts.very_low,
              counts.low,
              counts.moderate,
              counts.high,
              counts.very_high,
            ],
            backgroundColor: [
              "#e5e7eb",
              "#bae6fd",
              "#7dd3fc",
              "#0ea5e9",
              "#0369a1",
            ],
          },
        ],
      },
      options: { responsive: true, plugins: { legend: { display: false } } },
    }
  );
}

/* =========================================================
   10. AGGIORNAMENTO GRAFICI QUANDO CAMBIA LA LINGUA
   ========================================================= */

function updateChartsLanguage() {
  const t = I18N[currentLang];

  if (csiHistChart) {
    csiHistChart.data.labels = t.csiHistLabels;
    csiHistChart.update();
  }
  if (amenitiesChart) {
    amenitiesChart.data.labels = t.amenitiesLabels;
    amenitiesChart.data.datasets[0].label = t.amenitiesDatasetLabel;
    amenitiesChart.update();
  }
  if (cfiVsCsiChart) {
    cfiVsCsiChart.options.scales.x.title.text = t.cfiVsCsiLabelX;
    cfiVsCsiChart.options.scales.y.title.text = t.cfiVsCsiLabelY;
    cfiVsCsiChart.update();
  }
  if (fragilityClassChart) {
    fragilityClassChart.data.labels = t.fragilityClassLabels;
    fragilityClassChart.update();
  }
}

/* =========================================================
   11. TABS E FILTRI
   ========================================================= */

function initTabs() {
  const buttons = document.querySelectorAll(".tab-btn");
  const panels = document.querySelectorAll(".tab-panel");

  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const targetId = btn.dataset.tab;

      buttons.forEach((b) => b.classList.remove("active"));
      panels.forEach((p) => p.classList.remove("active"));

      btn.classList.add("active");
      document.getElementById(targetId).classList.add("active");

      if (targetId === "tab-csi" && mapCSI) mapCSI.resize();
      if (targetId === "tab-cfi" && mapCFI) mapCFI.resize();
    });
  });
}

function initCSIFilterUI() {
  document
    .querySelectorAll("#csi-filters .chip")
    .forEach((chip) => {
      chip.addEventListener("click", () => {
        document
          .querySelectorAll("#csi-filters .chip")
          .forEach((c) => c.classList.remove("active"));
        chip.classList.add("active");
        applyCSIFilter(chip.dataset.class);
      });
    });
}

/* =========================================================
   12. CAMBIO LINGUA UI
   ========================================================= */

function initLangSwitch() {
  document.querySelectorAll(".lang-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const lang = btn.dataset.lang;
      if (lang === currentLang) return;

      currentLang = lang;
      applyI18n();
      updateLanguageButtons();
      updateChartsLanguage();
    });
  });
}

/* =========================================================
   13. AVVIO DELLA PAGINA
   ========================================================= */

async function loadData() {
  // Carica JSON multilingua
  await loadI18n();

  // Carica dati delle mappe
  const [csiResp, cfiResp] = await Promise.all([
    fetch(CSI_GEOJSON_URL),
    fetch(CFI_GEOJSON_URL)
  ]);

  csiData = await csiResp.json();
  cfiData = await cfiResp.json();

  // Classi CSI
  csiData.features.forEach((f) => {
    f.properties.csi_class = classifyCSI(+f.properties.csi);
  });

  // Aggiorna numeri hero
  document.getElementById("stat-total-parks").textContent =
    csiData.features.length;

  const eligible = csiData.features.filter(
    (f) => f.properties.eligible == 1 || f.properties.candidate == 1
  );
  document.getElementById("stat-csi-eligible").textContent =
    eligible.length || 181;

  // Inizializza UI
  initLangSwitch();
  initCSIFilterUI();
  initTabs();

  // Inizializza mappe
  initMapCSI();
  initMapCFI();

  // Inizializza grafici
  buildCSIHistoChart(csiData.features);
  buildAmenitiesChart(eligible.length ? eligible : csiData.features);
  buildCFIvCSIChart();
  buildFragilityClassChart();

  // Applica lingua IT iniziale
  applyI18n();
  updateLanguageButtons();
}

loadData().catch(console.error);
</script>

